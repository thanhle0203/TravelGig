$(document).ready(function() {
  $("#searchBtn").click(function(){
    var searchText = $("#searchLocation").val();
    $('#tblHotel tr').not(':first').remove();
    $.get("http://localhost:8383/searchHotel/"+ searchText, {}, function(responseText) {
      $.each(responseText, function(key1, value1) {
		var amenities = value1.amenities.map(function(amenity) {
			return amenity.name;
		}).join(", ");
        var row = "<tr><td>" + value1.hotelName + "</td><td><img class='hotelImage' src='" + value1.imageURL + "' width='300' height='300'/></td><td>" + value1.averagePrice + "</td><td>" + value1.starRating + "</td><td>" + amenities + " </td></tr>";
        $("#tblHotel").append(row);
      });
    });
  });
  
$("#filterBtn").click(function(){
  var price = parseInt($("#priceValue").text());
  $("#tblHotel tr").not(":first").each(function() {
    $(this).show();
    var hotelPriceText = $(this).children("td").eq(2).text();
    var startRatingText = $(this).children("td").eq(3).text();
    var hotelPrice = /^\d+$/.test(hotelPriceText) ? parseInt(hotelPriceText) : null;
    var startRating = /^\d+$/.test(startRatingText) ? parseInt(startRatingText) : null;
    var flag = 0;
    $('.star_rating').each(function() {
      if (this.checked && $(this).val() == startRating) {
        flag = 1;
      }
    });
    if (flag == 0) {
      $(this).hide();
    } else if (price > hotelPrice) {
      $(this).hide();
    }
  });
});


  var responseText;

// Initialize datepicker with format option
$("#modal_CheckInDate").datepicker({
  format: "yyyy-mm-dd"
});
$("#modal_CheckOutDate").datepicker({
  format: "yyyy-mm-dd"
});

$("#tblHotel").on('click','.hotelImage', function() {
  var hotelName = $(this).parent().parent().children("td").eq(0).text();
  var searchText = $("#searchLocation").val();

  $.get("http://localhost:8383/searchHotel/" + searchText, function(response) {
    responseText = response;
    var hotelRoomTypes = responseText[0].hotelRooms;

    $("#myModal").modal();
    $("#modal_hotelName").val(hotelName);
    $("#modal_noGuests").val($("#noGuests").val());
    $("#modal_CheckInDate").val($("#checkInDate").val());
    $("#modal_CheckOutDate").val($("#checkOutDate").val());
    $("#modal_noRooms").val($("#noRooms").val());

    // Remove existing options before adding new ones
    $("#select_roomTypes").empty();

    for (var i=0; i< hotelRoomTypes.length; i+=1){
      $("#select_roomTypes").append($("<option />").val(hotelRoomTypes[i].type.name).text(hotelRoomTypes[i].type.name));
    }

  });
});


	$("#myModal").on('click','.btn-searchHotelRooms', function() {
  var hotelName = $("#modal_hotelName").val();
  var searchText = $("#searchLocation").val();

  $.get("http://localhost:8383/searchHotel/" + searchText, function(response) {
    var responseText = response;
    var hotelRoomTypes = responseText[0].hotelRooms;
    var hotelId = responseText[0].hotelId;
    var hotelRoomId = hotelRoomTypes.find(room => room.type.name === $("#select_roomTypes").val()).hotelRoomId;
    var customerMobile = $("#modal_customerMobile").val();
    var noGuests = $("#modal_noGuests").val();
    var noRooms = parseInt($("#modal_noRooms").val(), 10);
    var checkInDate = moment($("#modal_CheckInDate").val(), "YYYY-MM-DD");
    var checkOutDate = moment($("#modal_CheckOutDate").val(), "YYYY-MM-DD");

    var roomType = $("#select_roomTypes").val();

    // Validate check-in and check-out dates
    if (checkOutDate.isBefore(checkInDate)) {
      alert("Invalid date range: Check-out date must be after Check-in date.");
      return;
    }

    // Calculate discount and total price
    var discount = 0;
    var totalPrice = 0;
    var roomTypeObject = hotelRoomTypes.find(room => room.type.name === roomType);
    var pricePerNight = roomTypeObject.pricePerNight;
    var nights = checkOutDate.diff(checkInDate, 'days');
    var basePrice = pricePerNight * noRooms * nights;
    totalPrice = basePrice - discount;

    // Update confirm booking modal fields
    $("#booking_hotelId").val(hotelId);
    $("#booking_hotelRoomId").val(hotelRoomId);
    $("#booking_hotelName").val(hotelName);
    $("#booking_customerMobile").val(customerMobile);
    $("#booking_noGuests").val(noGuests);
    $("#booking_noRooms").val(noRooms);
    $("#booking_checkInDate").val(checkInDate.format("YYYY-MM-DD"));
    $("#booking_checkOutDate").val(checkOutDate.format("YYYY-MM-DD"));
    $("#booking_roomType").val(roomType);
    $("#booking_discount").text(discount);
    $("#booking_price").text(totalPrice);
    
    // Display booking hotel room modal
    $("#bookingHotelRoomModal").modal();
  });
});



});
