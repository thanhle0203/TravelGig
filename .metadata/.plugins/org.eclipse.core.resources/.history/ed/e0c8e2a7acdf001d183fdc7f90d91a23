package com.thanhle.domain;

$(document).ready(function() {
    // This code is a click event handler for the search button. It gets the search text from the searchLocation input field, sends a GET request to the server with that search text, and populates a table with the response data.
    // The first line gets the search text from the input field.
    // The second line removes all rows from the table except for the first row.
    // The third line sends a GET request to the server with the search text as a parameter. The server responds with a JSON object containing hotel data.
    // The fourth line loops through each hotel in the response object and creates an HTML row for it. The row contains the hotel name, image, average price, star rating, and amenities.
    // The fifth line appends the HTML row to the table.
    $("#searchBtn").click(function(){
      var searchText = $("#searchLocation").val();
      $('#tblHotel tr').not(':first').remove();
      $.get("http://localhost:8383/searchHotel/"+ searchText, {}, function(responseText) {
        $.each(responseText, function(key1, value1) {
          var amenities = value1.amenities.map(function(amenity) {
              return amenity.name;
          }).join(", ");
          var hotelName = value1.hotelName;
          var imageURL = value1.imageURL;
          var averagePrice = value1.averagePrice;
          var starRating = value1.starRating;
          var row = "<tr><td>" + hotelName + "</td><td><img class='hotelImage' src='" + imageURL + "' width='300' height='300'/></td><td>" + averagePrice + "</td><td>" + starRating + "</td><td>" + amenities + " </td></tr>";
          $("#tblHotel").append(row);
        });
      });
    });
    
    // This code filters the hotel results based on the selected price range and star rating
    // When the "Filter" button is clicked, it first gets the selected price range value and stores it in a variable
    // Then, it loops through each row of the hotel table, checks the price and star rating of the hotel, and determines whether it should be hidden or shown based on the filters
    // If the star rating filter is not met, the row is hidden
    // If the price filter is not met, the row is hidden
    // Otherwise, the row is shown
    $("#filterBtn").click(function(){
        var price = parseInt($("#priceValue").text());
            $("#tblHotel tr").not(":first").each(function() {
            $(this).show();
            var hotelPriceText = $(this).children("td").eq(2).text();
            var startRatingText = $(this).children("td").eq(3).text();
            var hotelPrice = /^\d+$/.test(hotelPriceText) ? parseInt(hotelPriceText) : null;
            var startRating = /^\d+$/.test(startRatingText) ? parseInt(startRatingText) : null;
            var flag = 0;
            $('.star_rating').each(function() {
                if (this.checked && $(this).val() == startRating) {
                flag = 1;
                }
            });
            if (flag == 0) {
                $(this).hide();
            } else if (price > hotelPrice) {
                $(this).hide();
            }
        });
    });
  
      // Define responseText variable
    var responseText;
    
    // Initialize datepicker with format option
    $("#modal_CheckInDate").datepicker({
        format: "yyyy-mm-dd"
    });
    
    $("#modal_CheckOutDate").datepicker({
        format: "yyyy-mm-dd"
    });
    
    // Click event handler for hotel image in table
    $("#tblHotel").on('click', '.hotelImage', function () {
        // Get hotel name and search text
        var hotelName = $(this).parent().parent().children("td").eq(0).text();
        var searchText = $("#searchLocation").val();
    
        // Send AJAX request to server to get hotel room types
        $.get("http://localhost:8383/searchHotel/" + searchText, function (response) {
            responseText = response;
            var hotelRoomTypes = responseText[0].hotelRooms;
        
            // Populate modal fields with data
            $("#myModal").modal();
            $("#modal_hotelName").val(hotelName);
            $("#modal_noGuests").val($("#noGuests").val());
            $("#modal_CheckInDate").val($("#checkInDate").val());
            $("#modal_CheckOutDate").val($("#checkOutDate").val());
            $("#modal_noRooms").val($("#noRooms").val());
        
            // Remove existing options before adding new ones
            $("#select_roomTypes").empty();
        
            // Populate room types dropdown with options
            // for (var i = 0; i < hotelRoomTypes.length; i += 1) {
                //$("#select_roomTypes").append($("<option />").val(hotelRoomTypes[i].type.name).text(hotelRoomTypes[i].type.name));
            //}
            
            hotelRoomTypes.forEach(function(roomType) {
                $("#select_roomTypes").append($("<option />").val(roomType.type.name).text(roomType.type.name));
            });
    
        });
    });

    
    // This code defines an event handler for when the "btn-searchHotelRooms" button is clicked within a modal with id "myModal". 
    // It retrieves various values from the modal's fields and performs some validation before calculating a total price for the booking. 
    // It then updates the fields of another modal with id "bookingHotelRoomModal" and displays it.
    
    $("#myModal").on('click', '.btn-searchHotelRooms', function () {
        var hotelName = $("#modal_hotelName").val();
        //var responseText = JSON.parse($("#modal_hotelDetails").val());
        var hotelId = responseText[0].hotelId;
        var hotelRoomTypes = responseText[0].hotelRooms;
        var hotelRoomId = hotelRoomTypes.find(room => room.type.name === $("#select_roomTypes").val()).hotelRoomId;
        var customerMobile = $("#modal_customerMobile").val();
        var noGuests = $("#modal_noGuests").val();
        var noRooms = parseInt($("#modal_noRooms").val(), 10);
        var checkInDate = moment($("#modal_checkInDate").val(), "YYYY-MM-DD");
        var checkOutDate = moment($("#modal_checkOutDate").val(), "YYYY-MM-DD");
    
    
        var roomType = $("#select_roomTypes").val();
    
        // Validate check-in and check-out dates
        if (moment(checkOutDate).isBefore(checkInDate)) {
            alert("Invalid date range: Check-out date must be after Check-in date.");
            return;
        }
    
        // Calculate discount and total price
        var totalPrice = 0;
        var roomTypeObject = hotelRoomTypes.find(room => room.type.name === roomType);
        if (!roomTypeObject) {
            alert("Invalid room type selected.");
            return;
        }
            
        var pricePerNight = responseText[0].averagePrice;
        if (isNaN(pricePerNight)) {
            alert("Invalid price for room type.");
            return;
        } 
        
        var discount = responseText[0].discount*pricePerNight/100;;
        
        var nights = moment(checkOutDate).diff(moment(checkInDate), 'days');
        var basePrice = pricePerNight * noRooms*nights;
    
        totalPrice = basePrice - discount;
    
        // Update confirm booking modal fields
        $("#booking_hotelId").val(hotelId);
        $("#booking_hotelRoomId").val(hotelRoomId);
        $("#booking_hotelName").val(hotelName);
        $("#booking_customerMobile").val(customerMobile);
        $("#booking_noGuests").val(noGuests);
        $("#booking_noRooms").val(noRooms);
        $("#booking_checkInDate").val(checkInDate);
        $("#booking_checkOutDate").val(checkOutDate);
        $("#booking_roomType").val(roomType);
        $("#booking_discount").text(discount);
        $("#booking_price").text(totalPrice);
        
        // Display booking hotel room modal
        $("#bookingHotelRoomModal").modal();
    });
    
    
    $("#btn_confirmBooking").on('click', function() {
        var hotelId = $("#booking_hotelId").val();
        var hotelRoomId = $("#booking_hotelRoomId").val();
        var customerMobile = $("#booking_customerMobile").val();
        var noGuests = $("#booking_noGuests").val();
        var noRooms = $("#booking_noRooms").val();
        var checkInDate = moment($("#booking_checkInDate").val()).format('MM-DD-YYYY');
        var checkOutDate = moment($("#booking_checkOutDate").val()).format('MM-DD-YYYY');
    
        var roomType = $("#booking_roomType").val();
        var discount = parseFloat($("#booking_discount").text());
        var totalPrice = parseFloat($("#booking_price").text());
        
        // Send AJAX request to server to confirm booking
        $.post("http://localhost:8383/confirmBooking", {
            hotelId: hotelId,
            hotelRoomId: hotelRoomId,
            customerMobile: customerMobile,
            noGuests: noGuests,
            noRooms: noRooms,
            checkInDate: checkInDate,
            checkOutDate: checkOutDate,
            roomType: roomType,
            discount: discount,
            totalPrice: totalPrice
        }, function(response) {
            alert("Booking confirmed!");
            $("#bookingHotelRoomModal").modal('hide');
        });
    });
  
  
  
  });
  